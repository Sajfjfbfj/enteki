<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1969e1">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">

  <title>MATOMA | 遠的スコア管理アプリ - 弓道の記録をスマホで簡単に分析</title>
  <meta name="description" content="MATOMA遠的は弓道の遠的スコアをスマホで簡単に記録・分析・共有できるアプリです。立ちごとの点数管理や矢所分析で、自分の射を可視化しましょう。" />
  <meta name="keywords" content="弓道,遠的,スコア管理,矢所分析,アプリ,MATOMA" />
  <meta name="robots" content="index, follow" />

  <meta property="og:title" content="MATOMA | 遠的スコア管理アプリ" />
  <meta property="og:description" content="遠的スコアをスマホで簡単に分析・共有！MATOMAで弓道の記録をもっと楽しく。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://enteki.vercel.app/" />
  <meta property="og:image" content="https://enteki.vercel.app/assets/img/aikonmato.png" />
  <meta property="og:site_name" content="MATOMA 遠的" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MATOMA | 遠的スコア管理アプリ" />
  <meta property="twitter:description" content="遠的スコアをスマホで簡単に分析・共有！MATOMAで弓道の記録をもっと楽しく。" />
  <meta property="twitter:image" content="https://enteki.vercel.app/assets/img/aikonmato.png" />
  <meta property="twitter:url" content="https://enteki.vercel.app/" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "MATOMA 遠的",
    "url": "https://enteki.vercel.app/",
    "description": "MATOMA遠的は弓道の遠的スコアをスマホで簡単に記録・分析・共有できるアプリです。",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://enteki.vercel.app/?s={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#1969e1",
            "background-light": "#f6f7f8",
            "background-dark": "#111721"
          },
          fontFamily: {
            "display": ["Manrope", "Yu Gothic", "Hiragino Maru Gothic ProN", "sans-serif"]
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js/dist/css/shepherd.css">

  <style>
    /* custom styles */
    body { padding-bottom: 120px; }
    .app-card { transition: transform .18s ease, box-shadow .18s ease; }
    .app-card:hover { transform: translateY(-4px); box-shadow: 0 18px 30px rgba(0,0,0,.08); }
    .center-tab-button { position: relative; top: -20px; width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#1969e1,#1557c7); color:white; border:none; box-shadow:0 8px 24px rgba(25,105,225,0.4); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .player-score-input { width:60px; max-width:60px; } 
    @media (min-width:768px){ .player-score-input{ width:70px; } }
    .canvas-container{ width:100%; max-width:600px; margin:0 auto; aspect-ratio:1/1; position:relative; }
    .canvas-container canvas{ width:100% !important; height:100% !important; display:block; }
    
    /* ★★★ 変更: スマホ表示用にレスポンシブ対応を追加 ★★★ */
    .player-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }
    .player-row-left, .player-row-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .player-row-right {
        flex-wrap: nowrap; /* PCでは折り返さない */
    }
    @media (max-width: 767px) {
        .player-row {
            flex-direction: column; /* スマホでは縦並び */
            align-items: stretch;
        }
        .player-row-left {
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .player-row-right {
            justify-content: space-between;
            flex-wrap: wrap; /* スマホではスコア入力を折り返す */
        }
        .player-score-input {
            flex-grow: 1;
            min-width: 60px;
        }
    }

    /* ★★★ 新規追加: フローティングストップウォッチのスタイル ★★★ */
    #floatingStopwatch {
        position: fixed;
        bottom: 80px;
        right: 16px;
        z-index: 100;
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        padding: 12px;
        width: 280px;
        touch-action: none; /* ドラッグ中のページスクロールを防止 */
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .dark #floatingStopwatch {
        background-color: rgba(30, 41, 59, 0.9);
    }
    #floatingStopwatch.hidden {
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
    }
    #floatingStopwatch .drag-handle {
        cursor: move;
        padding: 4px;
        text-align: center;
        color: #94a3b8;
    }
    #floatingStopwatch .drag-handle .material-symbols-outlined {
        font-size: 20px;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
  <div class="flex flex-col min-h-screen">

    <header class="sticky top-0 z-20 bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm border-b border-slate-100 dark:border-slate-800">
      <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <h1 class="text-lg font-bold text-slate-900 dark:text-white">MATOMA遠的</h1>
        <div class="flex items-center gap-2">
          <button id="shareBtn" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-semibold shadow-md">共有</button>
          <button id="settingsBtn" class="p-2 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200" title="設定">
            <span class="material-symbols-outlined text-2xl">settings</span>
          </button>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-4">
      <div class="flex gap-2 justify-center">
        <button id="personalTabBtn" class="px-4 py-2 rounded-lg font-semibold bg-primary text-white">個人用</button>
        <button id="teamTabBtn" class="px-4 py-2 rounded-lg font-semibold bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white">団体用</button>
      </div>
    </div>

    <main class="flex-grow container mx-auto px-4 pb-12">

      <section id="personalTab" class="tab-content active">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="app-card bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-lg" id="matchDateSection">
            <label for="matchDate" class="block mb-3 font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">calendar_today</span>
              日付選択
            </label>
            <input type="date" id="matchDate" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-4 py-3 text-slate-800 dark:text-slate-200 bg-white dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
          </section>

          <section id="dailySummary">
            <h2 class="text-xl font-bold mb-3 text-slate-900 dark:text-white">日別集計</h2>
            <div class="app-card bg-white dark:bg-slate-900 rounded-2xl shadow-lg p-5">
              <div class="flex items-center gap-3 text-slate-500 dark:text-slate-400">
                <span class="material-symbols-outlined text-3xl text-primary">analytics</span>
                <p class="text-sm">ここに日別集計（立ち数・合計点）が表示されます</p>
              </div>
            </div>
          </section>
        </div>

        <section class="mt-6">
          <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">立ちセット</h2>
          <div id="setsContainer" class="space-y-4"></div>
        </section>

        <div class="mt-6">
          <div class="hidden md:block fixed bottom-24 right-4 z-50">
            <button id="tutorialBtn" class="px-5 py-3 text-sm bg-primary text-white rounded-full shadow-xl">初めての方へ</button>
          </div>
          <div class="md:hidden w-full py-3 bg-background-light dark:bg-background-dark">
            <div class="container mx-auto px-4 flex justify-center">
              <button id="tutorialBtnMobile" class="px-6 py-3 text-base bg-primary text-white rounded-full shadow-lg">初めての方へ</button>
            </div>
          </div>
        </div>
      </section>

      <section id="teamTab" class="tab-content">

        <div class="py-2">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="flex items-center gap-2"> 
                <h2 id="roomTitle" class="text-2xl font-bold text-slate-900 dark:text-white">団体用スコア管理</h2>
                <div id="roomShareIcons" class="flex gap-1" style="display:none;">
                    <button id="shareIconBtn" class="p-1.5 rounded-full bg-primary/20 text-primary dark:bg-primary/50" title="共有リンク・コードをコピー">
                        <span class="material-symbols-outlined text-xl">content_copy</span>
                    </button>
                    <button id="qrIconBtn" class="p-1.5 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200" title="QRコードを表示/非表示">
                        <span class="material-symbols-outlined text-xl">qr_code_2</span>
                    </button>
                </div>
              </div>
              <p id="roomSubtitle" class="text-sm text-slate-600 dark:text-slate-300">ルームを作成して共有、メンバー登録ができます。</p>
            </div>
            <div id="roomEntryButtons" class="flex gap-2">
              <button id="createRoomBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md">ルーム作成</button>
              <button id="joinRoomBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">ルームに参加</button>
              <button id="leaveRoomBtn" style="display:none;" class="px-4 py-2 bg-red-500 text-white rounded-md">退室</button>
            </div>
          </div>

          <div id="roomControls" style="display:none;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div id="roomForm" style="display:none;" class="app-card bg-white dark:bg-slate-900 p-4 rounded-2xl shadow">
                <label class="block mb-2 font-bold text-slate-800 dark:text-slate-200">ルーム名</label>
                <input id="roomName" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-4 py-3 bg-white dark:bg-slate-800" placeholder="ルーム名を入力" />
                <div class="flex gap-2 mt-3">
                  <button id="submitRoomBtn" class="px-4 py-2 bg-green-500 text-white rounded-md">ルーム作成</button>
                  <button id="cancelRoomBtn" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-md">キャンセル</button>
                </div>
              </div>

              <div id="joinForm" style="display:none;" class="app-card bg-white dark:bg-slate-900 p-4 rounded-2xl shadow">
                <label class="block mb-2 font-bold text-slate-800 dark:text-slate-200">招待コードまたはURLを入力</label>
                <input id="joinInput" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-4 py-3 bg-white dark:bg-slate-800" placeholder="例: MATOMA_JOIN:RMXXXX または https://...#room=RMXXXX" />
                <div class="flex gap-2 mt-3">
                  <button id="doJoinBtn" class="px-4 py-2 bg-green-500 text-white rounded-md">参加</button>
                  <button id="cancelJoinBtn" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-md">キャンセル</button>
                </div>
              </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4">
              <div class="flex-1 space-y-4">
                <div id="memberControlButtons" class="flex gap-2">
                    <button id="openRegisterModalBtn" class="px-4 py-2 bg-primary text-white rounded-md font-semibold" style="display:none;">メンバー登録</button>
                    <button id="openManagementModalBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md font-semibold" style="display:none;">メンバー管理</button>
                </div>
                <div id="teamsContainer" class="flex flex-col md:flex-row md:flex-wrap gap-4"></div>
              </div>

              <aside id="sidebar-aside" class="w-full lg:w-96 space-y-4">
                <div class="app-card bg-white dark:bg-slate-900 rounded-2xl shadow p-4">
                  <h3 class="font-bold mb-3">ストップウォッチ</h3>
                  <div id="swDisplay" class="text-2xl font-mono mb-3">00:00.00</div>
                  <div class="flex gap-2 mb-3">
                    <button id="swStart" class="px-3 py-2 bg-green-500 text-white rounded-md flex-1">Start</button>
                    <button id="swPause" class="px-3 py-2 bg-yellow-500 text-white rounded-md flex-1">Pause</button>
                    <button id="swReset" class="px-3 py-2 bg-red-500 text-white rounded-md flex-1">Reset</button>
                  </div>
                  <button id="swLap" class="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-md w-full">Lap</button>
                  <ul id="lapList" class="mt-3 text-sm list-disc list-inside max-h-48 overflow-auto"></ul>
                </div>
                <div class="app-card bg-white dark:bg-slate-900 rounded-2xl shadow p-4">
                  <h3 class="font-bold mb-2">ルーム集計</h3>
                  <pre id="roomSummary" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">—</pre>
                </div>
              </aside>
            </div>
          </div>
          
          <div id="roomHistory" class="mt-8 pt-4 border-t border-slate-200 dark:border-slate-700">
              <h2 class="text-xl font-bold mb-3 text-slate-900 dark:text-white">過去のルーム履歴（ブラウザ保存）</h2>
              <div id="historyList" class="space-y-2">
                  <p class="text-sm text-slate-500" id="noHistoryMessage">履歴はありません。</p>
              </div>
          </div>
          </div>

        <div class="mt-6">
          <div class="hidden md:block fixed bottom-24 right-4 z-50">
            <button id="tutorialBtnTeam" class="px-5 py-3 text-sm bg-primary text-white rounded-full shadow-xl">初めての方へ（団体用）</button>
          </div>
          <div class="md:hidden w-full py-3 bg-background-light dark:bg-background-dark">
            <div class="container mx-auto px-4 flex justify-center">
              <button id="tutorialBtnMobileTeam" class="px-6 py-3 text-base bg-primary text-white rounded-full shadow-lg">初めての方へ（団体用）</button>
            </div>
          </div>
        </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white/90 dark:bg-slate-900/90 border-t border-slate-100 dark:border-slate-800">
      <div class="max-w-5xl mx-auto px-4 py-2 flex items-end justify-around relative">
        <a href="tools.html" class="flex flex-col items-center gap-1 py-1 px-2 text-slate-500 dark:text-slate-400">
          <span class="material-symbols-outlined text-2xl">construction</span>
          <span class="text-xs font-semibold">道具</span>
        </a>
        <a href="index.html" class="flex flex-col items-center gap-1 py-1 px-2 text-primary">
          <span class="material-symbols-outlined text-2xl">today</span>
          <span class="text-xs font-semibold">今日の記録</span>
        </a>

        <button id="addSetBtnTab" class="center-tab-button" title="立ちセットを追加">
          <span class="material-symbols-outlined text-3xl">add_circle</span>
        </button>

        <a href="yadokoro.html" class="flex flex-col items-center gap-1 py-1 px-2 text-slate-500 dark:text-slate-400">
          <span class="material-symbols-outlined text-2xl">analytics</span>
          <span class="text-xs font-semibold">分析</span>
        </a>
        <a href="help.html" class="flex flex-col items-center gap-1 py-1 px-2 text-slate-500 dark:text-slate-400">
          <span class="material-symbols-outlined text-2xl">help</span>
          <span class="text-xs font-semibold">ヘルプ</span>
        </a>
      </div>
    </nav>
  </div>

  <div id="modalWrapper" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4" onclick="if(event.target.id==='modalWrapper') closeModal()">
    <div id="modalContent" class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
      </div>
  </div>

  <div id="modalTemplates" class="hidden">
    <div id="qrModalContent" class="p-6 text-center">
      <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">ルーム招待QRコード</h3>
      <div id="qrCodeDisplayModal" class="flex justify-center mb-4"></div>
      <p class="text-sm text-slate-600 dark:text-slate-400">このQRコードを読み込むか、上部のコピーボタンでリンクを共有してください。</p>
      <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-slate-500 text-white rounded-lg">閉じる</button>
    </div>

    <div id="registerModalContent" class="p-6">
      <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">はじめて参加する方へ（メンバー登録）</h3>
      <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">あなたの名前と役割を入力して登録してください。登録後はスコアを入力できるようになります。</p>
      <input type="text" id="registerNameInput" placeholder="あなたの名前を入力" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-800 mb-2" />
      <select id="registerRoleSelect" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-3 py-2 text-slate-800 dark:text-slate-200 bg-white dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all mb-4">
        <option value="player">プレーヤー（スコア編集可能）</option>
        <option value="manager">監督者（スコア編集・管理操作可能）</option>
        <option value="other">その他（閲覧のみ）</option>
      </select>
      <div class="flex gap-2">
        <button id="registerSelfBtn" class="px-4 py-2 bg-primary text-white rounded-md flex-1">登録</button>
        <button id="skipRegisterBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md">キャンセル</button>
      </div>
    </div>

    <div id="managementModalContent" class="p-6">
      <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">メンバー操作（管理）</h3>
      <div class="space-y-2">
          <label for="newPlayerNameModal" class="block text-sm font-medium mb-1 text-slate-800 dark:text-slate-200">新しいプレイヤーの追加</label>
          <div class="flex gap-2">
              <input type="text" id="newPlayerNameModal" placeholder="プレイヤー名を入力" class="w-full rounded-xl border-2 border-slate-200 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-800" />
              <button id="addPlayerBtnModal" class="px-4 py-2 bg-primary text-white rounded-md">追加</button>
          </div>
          <div class="pt-2">
              <button id="autoAssignBtnModal" class="w-full px-4 py-2 bg-slate-300 text-slate-800 rounded-md">自動割当（3人）</button>
          </div>
      </div>
      <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
          <button onclick="closeModal()" class="w-full px-4 py-2 bg-slate-500 text-white rounded-md">閉じる</button>
      </div>
    </div>
  </div>

  <div id="floatingStopwatch" class="hidden">
    <div class="drag-handle">
      <span class="material-symbols-outlined">drag_indicator</span>
    </div>
    <div id="floatingSwDisplay" class="text-2xl font-mono mb-3 text-center">00:00.00</div>
    <div class="flex gap-2 mb-2">
        <button id="floatingSwStart" class="px-3 py-2 bg-green-500 text-white rounded-md flex-1 text-sm">Start</button>
        <button id="floatingSwPause" class="px-3 py-2 bg-yellow-500 text-white rounded-md flex-1 text-sm">Pause</button>
        <button id="floatingSwReset" class="px-3 py-2 bg-red-500 text-white rounded-md flex-1 text-sm">Reset</button>
    </div>
    <button id="floatingSwLap" class="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-md w-full text-sm">Lap</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ====================================================================
    // 2. 設定とグローバル変数
    // ====================================================================
    
    // ユーザー提供のFirebase認証情報を設定
    const firebaseConfig = {
      apiKey: "AIzaSyDqFm2sgV0uEWvx8XQy2kzc2PxoWuf8lFw",
      authDomain: "matoma-1bac1.firebaseapp.com",
      // Realtime Database URLはprojectIdから自動生成されるが、明示的に設定
      databaseURL: "https://matoma-1bac1-default-rtdb.firebaseio.com", 
      projectId: "matoma-1bac1",
      storageBucket: "matoma-1bac1.firebasestorage.app",
      messagingSenderId: "581046138191",
      appId: "1:581046138191:web:ac88f7ac08799895de413a",
      measurementId: "G-WWK72Z6RV0"
    };

    let currentRoomId = null;
    let currentRoomRef = null;
    let registeredPlayerId = localStorage.getItem('matomaRegisteredPlayerId'); // 登録プレイヤーIDをLocalStorageから取得
    let database;

    // ====================================================================
    // 3. 初期化と基本ユーティリティ
    // ====================================================================
    
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
    } catch (e) {
        console.error("Firebaseの初期化に失敗しました。", e);
        // UIにエラーを表示
        document.getElementById('roomTitle').innerText = 'リアルタイム機能は無効';
        document.getElementById('roomSubtitle').innerText = 'Firebaseの初期化に失敗しました。';
    }
    
    // ユーティリティ: ルームID（招待コード）を生成 (例: RMXXXXXX)
    const generateRoomId = () => {
        return 'RM' + Math.random().toString(36).substring(2, 8).toUpperCase();
    };
    // ユーティリティ: プレイヤーIDを生成 (例: P_XXXXXX)
    const generatePlayerId = () => {
        return 'P_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
    };

    // UI: タブ切り替え機能
    function switchTab(targetId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(targetId).classList.add('active');

        document.getElementById('personalTabBtn').classList.remove('bg-primary', 'text-white');
        document.getElementById('personalTabBtn').classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-800', 'dark:text-white');
        document.getElementById('teamTabBtn').classList.remove('bg-primary', 'text-white');
        document.getElementById('teamTabBtn').classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-800', 'dark:text-white');

        if (targetId === 'personalTab') {
            document.getElementById('personalTabBtn').classList.add('bg-primary', 'text-white');
            document.getElementById('personalTabBtn').classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-800', 'dark:text-white');
        } else if (targetId === 'teamTab') {
            document.getElementById('teamTabBtn').classList.add('bg-primary', 'text-white');
            document.getElementById('teamTabBtn').classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-800', 'dark:text-white');
        }
    }

    // UI: モーダル表示/非表示のヘルパー関数
    function openModal(templateId) {
        const template = document.getElementById(templateId);
        if (template) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = template.innerHTML;
            document.getElementById('modalWrapper').style.display = 'flex';
            // メンバー登録モーダルの特殊処理
            if (templateId === 'registerModalContent' && registeredPlayerId) {
                // 既に登録済みの場合、名前入力欄を非表示にしたり、表示内容を変えたりするなどのUI調整が可能
            }
        }
    }
    function closeModal() {
        document.getElementById('modalWrapper').style.display = 'none';
        document.getElementById('modalContent').innerHTML = '';
    }
    window.openModal = openModal;
    window.closeModal = closeModal;

    // ====================================================================
    // 4. 団体用スコア管理 (Firebaseロジック)
    // ====================================================================

    // A. ルームへの入室とリアルタイム同期リスナーの設定
    function enterRoom(roomId) {
        if (!database) return alert('Firebaseが初期化されていません。');
        
        currentRoomId = roomId;
        currentRoomRef = database.ref('rooms/' + roomId);

        // UIをルーム接続済みに切り替え
        document.getElementById('roomTitle').innerText = 'ルームID: ' + roomId;
        document.getElementById('roomSubtitle').innerText = 'リアルタイム同期中です。';
        document.getElementById('roomEntryButtons').style.display = 'none'; 
        document.getElementById('roomControls').style.display = 'block';
        document.getElementById('roomShareIcons').style.display = 'flex';
        document.getElementById('joinForm').style.display = 'none';
        document.getElementById('roomForm').style.display = 'none';
        document.getElementById('leaveRoomBtn').style.display = 'block';
        document.getElementById('openRegisterModalBtn').style.display = 'block'; // メンバー登録ボタンを表示
        document.getElementById('teamsContainer').innerHTML = '<h2>スコアを読み込み中...</h2>';
        
        // 招待コード（URL）の共有機能
        document.getElementById('shareIconBtn').onclick = () => {
            const shareUrl = window.location.origin + window.location.pathname + '#room=' + roomId;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('招待URLをクリップボードにコピーしました: ' + shareUrl);
            });
        };
        // QRコード表示機能
        document.getElementById('qrIconBtn').onclick = () => {
            openModal('qrModalContent');
            const shareUrl = window.location.origin + window.location.pathname + '#room=' + roomId;
            const qrContainer = document.getElementById('qrCodeDisplayModal');
            if(qrContainer) {
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: shareUrl,
                    width: 200,
                    height: 200,
                });
            }
        };

        // リアルタイムリスナーの設定: データの変更を監視し、UIを更新
        currentRoomRef.on('value', snapshot => {
            if (snapshot.exists()) {
                const roomData = snapshot.val();
                renderRoomData(roomData); // データをUIに反映
                // メンバー登録ボタンの表示制御
                if (!registeredPlayerId) {
                    document.getElementById('openRegisterModalBtn').style.display = 'block';
                } else {
                    document.getElementById('openRegisterModalBtn').style.display = 'none';
                    document.getElementById('openManagementModalBtn').style.display = 'block';
                }
            } else {
                // ルームがFirebaseから削除された場合
                alert('ルームが閉じられました。');
                leaveRoom();
            }
        });

        // URLハッシュを更新して共有を容易にする
        history.pushState('', document.title, window.location.pathname + window.location.search + '#room=' + roomId);
    }

    // B. リアルタイムデータに基づいたUI描画
    function renderRoomData(roomData) {
        document.getElementById('roomTitle').innerText = `ルーム名: ${roomData.name || currentRoomId}`;
        
        const teamsContainer = document.getElementById('teamsContainer');
        teamsContainer.innerHTML = '';
        let totalScoreSum = 0; // 全員の合計点の総和

        if (roomData.scores) {
            // スコアの合計計算
            const calculateTotal = (scores) => scores.reduce((a, b) => a + (parseInt(b) || 0), 0);
            
            // スコアで降順にソート
            const sortedPlayerIds = Object.keys(roomData.scores).sort((idA, idB) => {
                const totalA = calculateTotal(roomData.scores[idA].scores);
                const totalB = calculateTotal(roomData.scores[idB].scores);
                return totalB - totalA; 
            });

            sortedPlayerIds.forEach((playerId, index) => {
                const player = roomData.scores[playerId];
                const totalScore = calculateTotal(player.scores);
                totalScoreSum += totalScore;

                const isRegisteredPlayer = playerId === registeredPlayerId;
                const inputDisabled = !isRegisteredPlayer && (player.role !== 'manager'); // 自分が登録者でない場合、編集不可

                const playerDiv = document.createElement('div');
                playerDiv.className = 'app-card bg-white dark:bg-slate-900 p-4 rounded-2xl shadow w-full mt-2';
                playerDiv.innerHTML = `
                    <div class="player-row flex justify-between items-center" data-player-id="${playerId}">
                        <div class="player-row-left flex-shrink-0">
                            <span class="font-bold text-lg ${isRegisteredPlayer ? 'text-primary' : ''}">${index + 1}. ${player.name}</span>
                            <span class="text-sm text-slate-500 dark:text-slate-400">(${player.role === 'manager' ? '監督' : '選手'})</span>
                        </div>
                        <div class="player-row-right flex items-center space-x-1 sm:space-x-2 overflow-x-auto ml-2">
                            ${player.scores.map((score, idx) => `
                                <input type="number" min="0" max="10" value="${score}" 
                                       class="player-score-input w-10 sm:w-12 h-8 sm:h-10 rounded-md border text-center text-base
                                              ${isRegisteredPlayer ? 'border-primary dark:border-primary-light bg-primary/10 dark:bg-primary/20' : 'border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800'}" 
                                       data-arrow-index="${idx}" 
                                       ${inputDisabled ? 'disabled' : ''} />
                            `).join('')}
                            <span class="text-xl font-bold text-primary ml-2 flex-shrink-0 w-12 text-right">${totalScore}点</span>
                        </div>
                    </div>
                `;
                teamsContainer.appendChild(playerDiv);
            });
            // スコア入力リスナーを再設定
            setupScoreInputListeners();
        }

        // ルーム集計の更新
        const playerCount = roomData.scores ? Object.keys(roomData.scores).length : 0;
        document.getElementById('roomSummary').innerText = 
            `ルーム名: ${roomData.name || currentRoomId}\n` +
            `参加者数: ${playerCount}人\n` +
            `総合計点: ${totalScoreSum}点`;
    }

    // C. スコア入力時のリアルタイム更新処理
    function setupScoreInputListeners() {
        // イベントデリゲーションを使用してリスナーを一度だけ設定
        const container = document.getElementById('teamsContainer');
        container.removeEventListener('change', handleScoreChange); // 既存のリスナーを削除
        container.addEventListener('change', handleScoreChange);
    }
    
    function handleScoreChange(event) {
        const input = event.target;
        if (input.classList.contains('player-score-input') && currentRoomRef) {
            const row = input.closest('.player-row');
            if (!row) return;

            const playerId = row.dataset.playerId;
            const arrowIndex = parseInt(input.dataset.arrowIndex);
            
            // スコアを0-10に制限
            let newScore = parseInt(input.value) || 0;
            newScore = Math.min(10, Math.max(0, newScore));
            input.value = newScore; // UIの値を修正

            const playerScoresRef = currentRoomRef.child('scores').child(playerId).child('scores');
            
            // データベースのトランザクションで配列の特定のインデックスを更新
            playerScoresRef.once('value', snapshot => {
                let scoresArray = snapshot.val();
                if (!Array.isArray(scoresArray) || scoresArray.length < 4) {
                    // データが存在しない場合、初期化（遠的は4射が多いと仮定）
                    scoresArray = [0, 0, 0, 0];
                }
                scoresArray[arrowIndex] = newScore;
                
                // リアルタイムデータベースを更新。これが他の端末に即座に同期される。
                playerScoresRef.set(scoresArray).catch(error => {
                    console.error("スコア更新エラー:", error);
                });
            });
        }
    }
    
    // D. メンバー登録機能 (Modal)
    function registerSelf() {
        if (!currentRoomRef) return alert('先にルームに参加または作成してください。');
        
        const name = document.getElementById('registerNameInput').value.trim();
        const role = document.getElementById('registerRoleSelect').value;
        
        if (!name) return alert('名前を入力してください。');
        
        let idToUse = registeredPlayerId || generatePlayerId();
        
        const newPlayer = {
            name: name,
            role: role,
            scores: [0, 0, 0, 0] // 初期スコア
        };

        currentRoomRef.child('scores').child(idToUse).set(newPlayer).then(() => {
            registeredPlayerId = idToUse;
            localStorage.setItem('matomaRegisteredPlayerId', idToUse);
            alert(`メンバーとして登録されました: ${name}`);
            closeModal();
            // UIを更新
            document.getElementById('openRegisterModalBtn').style.display = 'none';
            document.getElementById('openManagementModalBtn').style.display = 'block';

        }).catch(error => {
            console.error("登録エラー:", error);
            alert('メンバー登録に失敗しました。');
        });
    }

    // E. メンバー管理機能 (Modal) - 新しいプレイヤーの追加
    function addNewPlayer(name, scores = [0, 0, 0, 0], role = 'player') {
        if (!currentRoomRef) return alert('先にルームに参加または作成してください。');
        if (!name) return alert('プレイヤー名を入力してください。');

        const newPlayerId = generatePlayerId();
        const newPlayer = { name, role, scores };

        currentRoomRef.child('scores').child(newPlayerId).set(newPlayer).then(() => {
            // 成功しても特別なアラートは不要（リアルタイム更新で画面に反映されるため）
        }).catch(error => {
            console.error("プレイヤー追加エラー:", error);
            alert('プレイヤーの追加に失敗しました。');
        });
    }

    // F. 退室機能
    function leaveRoom() {
        if (currentRoomId && currentRoomRef) {
            currentRoomRef.off('value'); // リアルタイムリスナーを解除
            currentRoomId = null;
            currentRoomRef = null;
            
            // URLハッシュをクリア
            history.pushState('', document.title, window.location.pathname + window.location.search);

            // UIを初期状態に戻す
            document.getElementById('roomTitle').innerText = '団体用スコア管理';
            document.getElementById('roomSubtitle').innerText = 'ルームを作成して共有、メンバー登録ができます。';
            document.getElementById('roomEntryButtons').style.display = 'flex';
            document.getElementById('roomControls').style.display = 'none';
            document.getElementById('roomShareIcons').style.display = 'none';
            document.getElementById('leaveRoomBtn').style.display = 'none';
            document.getElementById('openRegisterModalBtn').style.display = 'none';
            document.getElementById('openManagementModalBtn').style.display = 'none';
            document.getElementById('teamsContainer').innerHTML = '';
        }
    }


    // ====================================================================
    // 5. ストップウォッチ機能 (共通)
    // ====================================================================

    let swInterval = null;
    let swStartTime = 0;
    let swElapsedTime = 0;
    let swIsRunning = false;

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        const centi = String(Math.floor((ms % 1000) / 10)).padStart(2, '0');
        return `${minutes}:${seconds}.${centi}`;
    }

    function updateStopwatch() {
        const currentTime = Date.now();
        swElapsedTime = currentTime - swStartTime;
        const formattedTime = formatTime(swElapsedTime);
        
        // メインとフローティングの両方を更新
        document.getElementById('swDisplay').innerText = formattedTime;
        document.getElementById('floatingSwDisplay').innerText = formattedTime;
    }

    function startStopwatch() {
        if (swIsRunning) return;
        swIsRunning = true;
        swStartTime = Date.now() - swElapsedTime;
        swInterval = setInterval(updateStopwatch, 10);
    }

    function pauseStopwatch() {
        if (!swIsRunning) return;
        swIsRunning = false;
        clearInterval(swInterval);
        swInterval = null;
    }

    function resetStopwatch() {
        pauseStopwatch();
        swElapsedTime = 0;
        updateStopwatch();
        document.getElementById('lapList').innerHTML = '';
    }

    function lapStopwatch() {
        if (!swIsRunning) return;
        const lapTime = formatTime(swElapsedTime);
        const lapItem = document.createElement('li');
        lapItem.className = "text-slate-700 dark:text-slate-300";
        lapItem.innerText = `Lap ${document.getElementById('lapList').children.length + 1}: ${lapTime}`;
        document.getElementById('lapList').prepend(lapItem); // 最新を上に追加
    }

    // ====================================================================
    // 6. DOM操作とイベントリスナー設定
    // ====================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        // 初期タブ設定 (個人用をアクティブ)
        switchTab('personalTab');

        // タブ切り替えリスナー
        document.getElementById('personalTabBtn').addEventListener('click', () => switchTab('personalTab'));
        document.getElementById('teamTabBtn').addEventListener('click', () => switchTab('teamTab'));
        
        // --- 団体用 (Team) タブのリスナー ---
        
        // ルーム作成フォーム表示
        document.getElementById('createRoomBtn').addEventListener('click', () => {
             document.getElementById('roomForm').style.display = 'block';
             document.getElementById('joinForm').style.display = 'none';
        });
        // ルーム作成キャンセル
        document.getElementById('cancelRoomBtn').addEventListener('click', () => {
             document.getElementById('roomForm').style.display = 'none';
        });
        
        // ルーム参加フォーム表示
        document.getElementById('joinRoomBtn').addEventListener('click', () => {
             document.getElementById('roomForm').style.display = 'none';
             document.getElementById('joinForm').style.display = 'block';
        });
        // ルーム参加キャンセル
        document.getElementById('cancelJoinBtn').addEventListener('click', () => {
             document.getElementById('joinForm').style.display = 'none';
        });

        // ルーム作成ボタンのリスナー
        document.getElementById('submitRoomBtn').addEventListener('click', () => {
            const roomName = document.getElementById('roomName').value || '無題のルーム';
            const roomId = generateRoomId();
            
            // ルーム作成者が自動で「監督者」として登録される
            let idToUse = registeredPlayerId || generatePlayerId();
            const initialRoomData = {
                name: roomName,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                scores: {
                    [idToUse]: { name: 'ルーム作成者', role: 'manager', scores: [0, 0, 0, 0] }
                }
            };
            
            // LocalStorageに登録IDを保存
            registeredPlayerId = idToUse;
            localStorage.setItem('matomaRegisteredPlayerId', idToUse);

            const roomRef = database.ref('rooms/' + roomId);
            roomRef.set(initialRoomData).then(() => {
                alert(`ルーム「${roomName}」を作成しました。招待コード: ${roomId}`);
                enterRoom(roomId);
            }).catch(error => {
                console.error("ルーム作成エラー:", error);
                alert('ルームの作成に失敗しました。');
            });
        });

        // 招待コード/URLで参加ボタンのリスナー
        document.getElementById('doJoinBtn').addEventListener('click', () => {
            const joinInput = document.getElementById('joinInput').value.trim();
            let roomId = null;

            // 招待コードの形式をパース（MATOMA_JOIN:RMXXXX, URLのハッシュ, またはRMXXXXのみ）
            if (joinInput.startsWith('MATOMA_JOIN:')) {
                roomId = joinInput.replace('MATOMA_JOIN:', '').trim();
            } else if (joinInput.includes('#room=')) {
                try {
                    const url = new URL(joinInput);
                    roomId = url.hash.substring(url.hash.indexOf('room=') + 5);
                } catch (e) {
                    // URLとして無効な場合は、そのままコードとして試行（主に開発用）
                    roomId = joinInput.substring(joinInput.indexOf('#room=') + 6);
                }
            } else if (joinInput.length > 3 && joinInput.length <= 8 && /^[A-Z0-9]+$/.test(joinInput)) {
                roomId = joinInput;
            }

            if (roomId) {
                database.ref('rooms/' + roomId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        enterRoom(roomId);
                        alert(`ルームID: ${roomId} に参加しました。`);
                    } else {
                        alert('無効な招待コードです。');
                    }
                });
            } else {
                alert('有効な招待コードまたはURLを入力してください。');
            }
        });
        
        // 退室ボタンのリスナー
        document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
        
        // メンバー登録モーダルを開く
        document.getElementById('openRegisterModalBtn').addEventListener('click', () => openModal('registerModalContent'));
        // メンバー管理モーダルを開く（UI要素は残しつつ、中身は未実装）
        document.getElementById('openManagementModalBtn')?.addEventListener('click', () => openModal('managementModalContent'));
        
        // メンバー登録アクション (Modal内)
        document.getElementById('modalWrapper').addEventListener('click', (event) => {
             if (event.target.id === 'registerSelfBtn') {
                registerSelf();
             } else if (event.target.id === 'skipRegisterBtn') {
                closeModal();
             } else if (event.target.id === 'addPlayerBtnModal') {
                const name = document.getElementById('newPlayerNameModal').value.trim();
                addNewPlayer(name);
                document.getElementById('newPlayerNameModal').value = ''; // 入力欄をクリア
             } else if (event.target.id === 'autoAssignBtnModal') {
                for (let i = 1; i <= 3; i++) {
                    addNewPlayer(`プレイヤー ${i + 1}`);
                }
             }
        });

        // --- ストップウォッチのリスナー (サイドバー) ---
        document.getElementById('swStart').addEventListener('click', startStopwatch);
        document.getElementById('swPause').addEventListener('click', pauseStopwatch);
        document.getElementById('swReset').addEventListener('click', resetStopwatch);
        document.getElementById('swLap').addEventListener('click', lapStopwatch);

        // --- ストップウォッチのリスナー (フローティング) ---
        document.getElementById('floatingSwStart').addEventListener('click', startStopwatch);
        document.getElementById('floatingSwPause').addEventListener('click', pauseStopwatch);
        document.getElementById('floatingSwReset').addEventListener('click', resetStopwatch);
        document.getElementById('floatingSwLap').addEventListener('click', lapStopwatch);

        // --- フローティングストップウォッチのドラッグ機能 ---
        const floatingSw = document.getElementById('floatingStopwatch');
        const swHandle = floatingSw.querySelector('.drag-handle');
        let isDragging = false;
        let startX, startY, initialX, initialY;

        swHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            initialX = floatingSw.offsetLeft;
            initialY = floatingSw.offsetTop;
            startX = e.clientX;
            startY = e.clientY;
            e.preventDefault(); // テキスト選択を防ぐ
        });
        swHandle.addEventListener('touchstart', (e) => {
            isDragging = true;
            initialX = floatingSw.offsetLeft;
            initialY = floatingSw.offsetTop;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            floatingSw.style.left = `${initialX + dx}px`;
            floatingSw.style.top = `${initialY + dy}px`;
        });
        document.addEventListener('touchmove', (e) => {
            if (!isDragging || e.touches.length === 0) return;
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            floatingSw.style.left = `${initialX + dx}px`;
            floatingSw.style.top = `${initialY + dy}px`;
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        document.addEventListener('touchend', () => {
            isDragging = false;
        });
        
        // サイドバーのストップウォッチ表示/非表示に連動
        document.getElementById('swStart').addEventListener('click', () => floatingSw.classList.remove('hidden'));
        document.getElementById('swReset').addEventListener('click', () => floatingSw.classList.add('hidden'));


        // --- URLハッシュからの自動参加 ---
        const hash = window.location.hash;
        if (hash.startsWith('#room=')) {
            const roomIdFromUrl = hash.substring(6);
            if (roomIdFromUrl) {
                // 自動参加を試みる
                document.getElementById('joinInput').value = roomIdFromUrl;
                // 自動参加は非同期のFirebase呼び出しに依存するため、少し遅延させてUIレンダリングを優先
                setTimeout(() => {
                    document.getElementById('doJoinBtn').click();
                    switchTab('teamTab'); // 団体用タブに切り替え
                }, 100);
            }
        }
        
        // --- その他の初期化 (ダミー/未実装機能) ---
        // 個人用タブの立ちセット追加ボタン
        document.getElementById('addSetBtnTab')?.addEventListener('click', () => {
             alert('個人用機能は現在実装中です。'); 
        });
        
        // ページロード時に団体用タブのストップウォッチを隠す
        floatingSw.classList.add('hidden');
    });
  </script>
  
  <script>
    // Service Workerのエラー（404）を回避するため、登録処理自体をコメントアウト/削除することを推奨します。
  </script>
  </body>
</html>